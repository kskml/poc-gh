def clean_confluence_html(html_content):
    """
    Replaces specific Diagram macros with clean text.
    STRATEGY: REMOVED General Fallback Cleanup.
    To guarantee headers are never skipped, we only clean macros we explicitly target.
    Other macros (Panels, Info Macros, etc.) are left for markdownify to handle.
    """
    print("   Cleaning ONLY Draw.io and PlantUML macros (Preserving all other content)...")
    
    # 1. Draw.io
    pattern_drawio = re.compile(
        r'<ac:structured-macro ac:name=".*?drawio.*?"[^>]*>(?!.*<ac:structured-macro>).*?' + 
        r'<ac:parameter ac:name="diagramName">(.*?)</ac:parameter>' + 
        r'.*?</ac:structured-macro>', 
        re.DOTALL | re.IGNORECASE
    )

    def replace_drawio(match):
        name = match.group(1).strip()
        return f"\n\n**[Draw.io Diagram: {name}]**\n\n"

    cleaned_html = pattern_drawio.sub(replace_drawio, html_content)

    # 2. PlantUML (Handle namespaces and multiple parameters)
    params_to_try = ['diagramName', 'title', 'filename', 'name']
    
    for param in params_to_try:
        pattern_plantuml = re.compile(
            r'<ac:structured-macro ac:name=".*?plantuml.*?"[^>]*>(?!.*<ac:structured-macro>).*?' + 
                f'<ac:parameter ac:name="{param}">(.*?)</ac:parameter>' + 
                r'.*?</ac:structured-macro>', 
            re.DOTALL | re.IGNORECASE
        )
        
        if pattern_plantuml.search(cleaned_html):
            cleaned_html = pattern_plantuml.sub(lambda m: f"\n\n**[PlantUML Diagram: {m.group(1).strip()}]**\n\n", cleaned_html)
            break 

    # 3. Fallback for PlantUML (No name found)
    pattern_plantuml_generic = re.compile(
        r'<ac:structured-macro ac:name=".*?plantuml.*?"[^>]*>(?!.*<ac:structured-macro>).*?</ac:structured-macro>', 
        re.DOTALL | re.IGNORECASE
    )
    
    if pattern_plantuml_generic.search(cleaned_html):
        print("      ⚠️  Using Fallback for unnamed PlantUML diagram.")
        cleaned_html = pattern_plantuml_generic.sub("\n\n**[PlantUML Diagram]**\n\n", cleaned_html)

    # --- REMOVED: General Fallback Cleanup ---
    # We are NOT deleting any other macros to ensure headers are NEVER skipped.
    # If there is 'garbage' text from other macros, it's better to see it than lose headers.
    
    return cleaned_html
