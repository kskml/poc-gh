def clean_confluence_html(html_content):
    """
    Replaces complex macros with clean text.
    FIX: Removed generic macro fallback to prevent deleting headers inside other macros.
    """
    print("   Cleaning macros (Draw.io & PlantUML)...")
    
    # 1. Draw.io
    pattern_drawio = re.compile(
        r'<ac:structured-macro ac:name=".*?drawio.*?"[^>]*>.*?' + 
        r'<ac:parameter ac:name="diagramName">(.*?)</ac:parameter>' + 
        r'.*?</ac:structured-macro>', 
        re.DOTALL | re.IGNORECASE
    )

    def replace_drawio(match):
        name = match.group(1).strip()
        return f"\n\n**[Draw.io Diagram: {name}]**\n\n"

    cleaned_html = pattern_drawio.sub(replace_drawio, html_content)

    # 2. PlantUML (Handle namespaces and multiple parameters)
    params_to_try = ['diagramName', 'title', 'filename', 'name']
    
    for param in params_to_try:
        pattern_plantuml = re.compile(
            r'<ac:structured-macro ac:name=".*?plantuml.*?"[^>]*>.*?' + 
                f'<ac:parameter ac:name="{param}">(.*?)</ac:parameter>' + 
                r'.*?</ac:structured-macro>', 
            re.DOTALL | re.IGNORECASE
        )
        
        if pattern_plantuml.search(cleaned_html):
            cleaned_html = pattern_plantuml.sub(lambda m: f"\n\n<<< PLANTUML DIAGRAM: {m.group(1).strip()} >>>\n\n", cleaned_html)
            break 

    # 3. Fallback for PlantUML (No name found)
    pattern_plantuml_generic = re.compile(
        r'<ac:structured-macro ac:name=".*?plantuml.*?"[^>]*>.*?</ac:structured-macro>', 
        re.DOTALL | re.IGNORECASE
    )
    
    if pattern_plantuml_generic.search(cleaned_html):
        print("      ⚠️  Using Fallback for unnamed PlantUML diagram.")
        cleaned_html = pattern_plantuml_generic.sub("\n\n<<< PLANTUML DIAGRAM >>>\n\n", cleaned_html)

    # --- REMOVED: Generic Fallback Cleanup ---
    # Previous code:
    # fallback_pattern = re.compile(r'<ac:structured-macro[^>]*>.*?</ac:structured-macro>', re.DOTALL)
    # cleaned_html = fallback_pattern.sub("\n\n**[Confluence Macro]**\n\n", cleaned_html)
    # This was deleting headers inside other macros.
    
    return cleaned_html
