import os
import subprocess
import shutil
import requests
import json

def create_docs_pr(
    docs_repo_name: str,
    pat_token: str,
    file_path: str,
    file_content: str,
    original_pr_number: str,
    original_pr_url: str,
    original_pr_author: str,
    source_repo_name: str,
    base_branch: str = "main"
):
    """
    Creates a new branch and a pull request in a separate documentation repository.

    Args:
        docs_repo_name (str): The full name of the documentation repository (e.g., "my-org/my-project-docs").
        pat_token (str): A Personal Access Token with 'repo' scope.
        file_path (str): The path where the new file should be created in the docs repo (e.g., "src/docs/api-changes.md").
        file_content (str): The Markdown content for the new documentation file.
        original_pr_number (str): The PR number from the source repository that triggered this.
        original_pr_url (str): The URL of the original source PR.
        original_pr_author (str): The username of the author of the original PR.
        source_repo_name (str): The name of the source repository (e.g., "my-org/my-project").
        base_branch (str, optional): The base branch to merge the documentation PR into. Defaults to "main".
    
    Returns:
        bool: True if the PR was created successfully, False otherwise.
    """
    print(f"--- Starting documentation PR process for repo: {docs_repo_name} ---")

    # Define branch and PR details
    new_branch_name = f"ai-docs-update-for-pr-{original_pr_number}"
    pr_title = f"docs: [AI-Generated] Documentation updates for {source_repo_name} PR #{original_pr_number}"
    
    # Standard PR Body
    pr_body = f"""
### ü§ñ AI-Generated Documentation

This pull request was automatically generated by the LLM code review bot for **[{source_repo_name} PR #{original_pr_number}]({original_pr_url})**.

#### Summary of Changes
The AI identified necessary documentation updates and has created a new file:
- **`{file_path}`**: Created.

#### Context
Please review the proposed documentation changes for accuracy and completeness. This PR aims to keep our documentation in sync with the codebase changes introduced in the original PR.

*Original PR Author: @{original_pr_author}*
    """

    temp_dir = None
    try:
        # 1. Clone the docs repository into a temporary directory
        temp_dir = f"temp_docs_repo_{original_pr_number}"
        clone_url = f"https://{pat_token}@github.com/{docs_repo_name}.git"
        print(f"Cloning {docs_repo_name} into {temp_dir}...")
        run_git_command(["clone", clone_url, temp_dir], ".")
        
        # 2. Configure git user and create a new branch
        print(f"Creating and checking out branch '{new_branch_name}'...")
        run_git_command(["config", "user.name", "github-actions[bot]"], temp_dir)
        run_git_command(["config", "user.email", "github-actions[bot]@users.noreply.github.com"], temp_dir)
        run_git_command(["checkout", "-b", new_branch_name], temp_dir)
        
        # 3. Create the new documentation file
        full_file_path = os.path.join(temp_dir, file_path)
        print(f"Writing new file to {full_file_path}...")
        
        # Ensure the directory exists before writing the file
        os.makedirs(os.path.dirname(full_file_path), exist_ok=True)
        
        with open(full_file_path, "w") as f:
            f.write(file_content)
        
        # 4. Commit and push the changes
        print("Staging and committing changes...")
        run_git_command(["add", full_file_path], temp_dir)
        commit_msg = f"feat: Add documentation updates for {source_repo_name} PR #{original_pr_number}"
        run_git_command(["commit", "-m", commit_msg], temp_dir)
        
        print(f"Pushing branch '{new_branch_name}' to remote...")
        run_git_command(["push", "origin", new_branch_name], temp_dir)
        
        # 5. Create the Pull Request via the GitHub API
        print("Creating pull request via API...")
        api_url = f"https://api.github.com/repos/{docs_repo_name}/pulls"
        headers = {"Authorization": f"token {pat_token}", "Accept": "application/vnd.github.v3+json"}
        data = {
            "title": pr_title,
            "body": pr_body,
            "head": new_branch_name,
            "base": base_branch
        }
        response = requests.post(api_url, headers=headers, json=data)
        
        if response.status_code == 201:
            pr_data = response.json()
            print(f"‚úÖ Documentation Pull Request created successfully: {pr_data['html_url']}")
            return True
        else:
            print(f"‚ùå Failed to create pull request: {response.status_code} - {response.text}")
            return False

    except Exception as e:
        print(f"An error occurred during docs PR creation: {e}")
        return False
    finally:
        # 6. Clean up the temporary directory
        if temp_dir and os.path.exists(temp_dir):
            print(f"Cleaning up temporary directory: {temp_dir}")
            shutil.rmtree(temp_dir)


def run_git_command(command, cwd):
    """Runs a git command in a specified directory and returns its output."""
    try:
        result = subprocess.run(
            ["git"] + command,
            cwd=cwd,
            check=True,
            capture_output=True,
            text=True
        )
        return result.stdout.strip()
    except subprocess.CalledProcessError as e:
        print(f"Error running git command {' '.join(command)}: {e.stderr}")
        raise # Re-raise the exception to stop the process if a git command fails

# --- EXAMPLE USAGE ---
# This is how you would call the function in your main script.
# For now, you can run this as a standalone script to test it.

if __name__ == "__main__":
    # --- Replace these with your actual values for testing ---
    TEST_DOCS_REPO = "your-org/your-docs-repo"  # IMPORTANT: Use a real test repo
    TEST_PAT = "ghp_YourPersonalAccessTokenHere" # IMPORTANT: Use a real PAT
    TEST_FILE_PATH = "src/docs/new-api-endpoint.md"
    TEST_FILE_CONTENT = """
# New User Endpoint

## Description
Adds a new endpoint to create a user.

## Endpoint
`POST /api/v1/users`

## Request Body
```json
{
  "username": "string",
  "email": "string"
}
