Confluence Integration: Identifying and Fetching Documentation
{info:title=Purpose}
This page outlines the technical implementation for fetching content from Confluence. The workflow intelligently identifies the most relevant architecture documentation pages based on the code changes in a Pull Request and retrieves their content for AI analysis.
{info}

1. Workflow Overview
The CI/CD pipeline executes a multi-step process to gather the necessary documentation context from Confluence.

Identify Relevant Pages: The job analyzes the changed files in the PR and uses a configuration file to determine which Confluence pages are relevant. This is done via a robust label-based search, not a brittle page path.
Search for Pages: It uses the collected labels to query the Confluence Search API, which returns a list of matching page IDs.
Fetch Page Content: For each page ID found, it makes a call to the Confluence Content API to get the full content in a structured format.
Format for AI: The fetched content is converted from Confluence's internal format to clean Markdown, making it easy for the AI model to process.
2. Step-by-Step Execution and API Details
Step 1: Identify the Right Confluence Pages (The "Smart Path" Method)
A common mistake is to try and map code to a static Confluence page URL (e.g., .../pages/12345/payment-arch). This is brittle because page IDs and URLs can change. Our method is more robust.

Purpose: To determine which Confluence pages are relevant to the code changes without relying on fixed URLs.
Method: Label-Based Discovery
The CI/CD script gets the list of all files that were changed in the merged Pull Request.
It reads a configuration file (arch-docs.yml) from the repository root. This file acts as a map, linking code patterns to Confluence labels.
The script iterates through the changed files. For each file, it checks the mappings in the config file. If a file path matches a code_path_pattern, the script collects the corresponding confluence_labels and confluence_space_key.
Example arch-docs.yml:
{code:lang=yaml}

Mapping from code patterns to Confluence documentation
mappings:

code_path_pattern: "src/services/payment/*"
confluence_labels: ["payment-service", "architecture"]
confluence_space_key: "ARCH"
code_path_pattern: "libs/shared/*"
confluence_labels: ["shared-library", "architecture"]
confluence_space_key: "ARCH"
{code}
API 1: Search for Relevant Pages
Once the script has a list of labels and a space key, it uses the Search API to find the pages.

Method & Endpoint: GET /rest/api/search
Purpose: To query Confluence and find all pages that match the given labels within a specific space.
Sample Request:
{code:lang=http}
GET /rest/api/search?cql=space=%22ARCH%22%20and%20label%20in%20(%22payment-service%22,%22architecture%22)&expand=version HTTP/1.1
Host: your-domain.atlassian.net
Authorization: Basic <base64_encoded_email_and_token>
Content-Type: application/json
{code}

Parameter Breakdown (Query Parameters)
| Parameter | Description | Sample Value |
| :--- | :--- | :--- |
| `cql` | **Confluence Query Language (CQL)**. This is the core of the search. The value must be URL-encoded. | `space = "ARCH" and label in ("payment-service","architecture")` |
| `expand` | A comma-separated list of properties to expand in the response. We request `version` to ensure we get the latest version of the page. | `version` |

Sample Response
{code:lang=json}
{
"results": [
{
"id": "12345",
"type": "page",
"status": "current",
"title": "Payment Service Architecture",
"extensions": { "position": 0 },
"_links": {
"webui": "/spaces/ARCH/pages/12345/Payment+Service+Architecture"
},
"version": {
"by": { "type": "known", "accountId": "..." },
"when": "2023-10-27T10:00:00.000Z",
"message": "Updated API endpoint details",
"number": 15
}
}
// ... more results if any
],
"start": 0,
"limit": 25,
"size": 1
}
{code}
The CI/CD script parses this response to get the id of each relevant page (e.g., 12345).

API 2: Fetch Page Content
With the page IDs from the search results, the script now fetches the full content of each page.

Method & Endpoint: GET /rest/api/content/{id}
Purpose: To retrieve the full body content of a specific Confluence page in its native "storage format".
Sample Request:
{code:lang=http}
GET /rest/api/content/12345?expand=body.storage HTTP/1.1
Host: your-domain.atlassian.net
Authorization: Basic <base64_encoded_email_and_token>
Content-Type: application/json
{code}

Parameter Breakdown (Query Parameters)
| Parameter | Description | Sample Value |
| :--- | :--- | :--- |
| `id` | (In URL) The unique ID of the page to fetch. | `12345` |
| `expand` | Specifies which additional properties to include in the response. `body.storage` is critical as it returns the page content in a structured XHTML-like format. | `body.storage` |

Sample Response
{code:lang=json}
{
"id": "12345",
"type": "page",
"title": "Payment Service Architecture",
"space": { "id": 20001, "key": "ARCH", "name": "Architecture" },
"body": {
"storage": {
"value": "<h1>Payment Service Architecture</h1><p>The payment service is responsible for processing transactions.</p><ac:structured-macro ac:name="code" ac:schema-version="1"><ac:parameter ac:name="language">java</ac:parameter>ac:plain-text-body<![CDATA[public class OldPaymentProcessor { ... }]]></ac:plain-text-body></ac:structured-macro>",
"representation": "storage",
"embeddedContent": []
}
},
"version": { "by": { ... }, "when": "2023-10-27T10:00:00.000Z", "number": 15 }
}
{code}
The CI/CD script extracts the body.storage.value and converts it to clean Markdown before sending it to the AI.
3. Summary of Confluence APIs
| Action | API Endpoint | Purpose in Workflow | Key Parameters |
| :--- | :--- | :--- | :--- |
| **Search for Pages** | `GET /rest/api/search` | To find pages that match the labels derived from the code changes. | `cql`, `expand` |
| **Fetch Page Content** | `GET /rest/api/content/{id}` | To get the full content of the pages identified in the search. | `expand=body.storage` |

4. Authentication
All requests to the Confluence API are authenticated using a Confluence API Token.

Token Name: CONFLUENCE_API_TOKEN
Storage: This token is securely stored as a secret in the CI/CD platform.
Usage: The token is used with Basic Authentication, identical to the Jira API method.
