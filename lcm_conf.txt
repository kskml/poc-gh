# Add to imports at top
from bs4 import BeautifulSoup

# ... (keep other imports and code) ...

def clean_confluence_html(html_content):
    """
    Uses BeautifulSoup to safely remove macros and inject placeholders.
    This guarantees headers and text are NOT deleted or skipped.
    """
    print("   Cleaning macros with BeautifulSoup (Safe Mode)...")
    
    soup = BeautifulSoup(html_content, 'html.parser')
    
    # Find all structured macros
    macros = soup.find_all('ac:structured-macro')
    
    if not macros:
        print("      No macros found in HTML.")
        return str(soup)
        
    print(f"      Found {len(macros)} macros to process.")
    
    for macro in macros:
        macro_name = macro.get('ac:name', '').lower()
        
        # Check if it is a diagram macro
        if 'plantuml' in macro_name or 'drawio' in macro_name or 'draw.io' in macro_name:
            diag_name = "Unknown"
            
            # Try to find name in parameters
            params = macro.find_all('ac:parameter')
            for param in params:
                param_name = param.get('ac:name', '').lower()
                # Check various possible parameter names
                if param_name in ['diagramname', 'title', 'filename', 'name']:
                    diag_name = param.get_text(strip=True)
                    break
            
            # Create placeholder comment node
            # We use a string node for simplicity
            if 'plantuml' in macro_name:
                placeholder = f"\n\n<<< PLANTUML DIAGRAM: {diag_name} >>>\n\n"
            else:
                placeholder = f"\n\n**[Draw.io Diagram: {diag_name}]**\n\n"
            
            # Replace the macro tag with the placeholder text
            # This deletes the whole <ac:structured-macro> node safely
            # preventing it from consuming surrounding headers/text
            macro.replace_with(placeholder)
    
    # Convert back to string for markdownify
    return str(soup)
