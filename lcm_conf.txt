def analyze_single_section(client, deployment_name, section_header, section_content, full_diff, local_diag_path):
    """
    Invokes LLM with Text AND Diagram context.
    UPDATED: Brevity, Standard PlantUML, Strict Conformant Filtering.
    """
    
    # 1. Check Exclusions
    for exclude_term in exclude_list:
        if exclude_term.lower() in section_header.lower():
            print(f"      ‚è≠Ô∏è  Section excluded (Matches '{exclude_term}').")
            return "NO_IMPACT"
    
    # 2. Regex for Diagrams
    pattern = re.compile(r'<<<\s*(PLANTUML|DRAWIO|DRAW)\s*DIAGRAM(.*?)\s*>>>', re.IGNORECASE)
    matches = pattern.findall(section_content)
    
    if len(matches) == 0:
        if "DIAGRAM" in section_content:
            print(f"      ‚ö†Ô∏è  Word 'DIAGRAM' found but regex didn't match.")
            snippet = section_content[:500]
            print(f"      Section Start Snippet: {snippet}...")
        else:
            print(f"      ‚ÑπÔ∏è  No diagrams detected in this section.")

    diagram_contexts = []
    
    for match in matches:
        diag_type, diag_name = match
        diag_name = diag_name.strip(" :")
        if not diag_name:
            diag_name = "Unknown"
        
        if "plantuml" in diag_type.lower():
            diag_content = find_local_diagram(diag_name, local_diag_path)
            if diag_content:
                diagram_contexts.append(f"\n--- DIAGRAM CONTEXT: {diag_name} ---\n{diag_content}\n")
    
    prompt_diagrams = "\n".join(diagram_contexts) if diagram_contexts else "No local diagrams found for this section."
    
    system_prompt = """
    You are an ASPICE SWE.2 Auditor analyzing a Documentation Section against Code Changes.
    
    **Context:**
    1. Confluence Text Content.
    2. (Optional) Local PlantUML Diagrams.
    
    **Instructions:**
    1. Check if Code Diff affects Text OR Diagram Logic.
    2. **Strict Output Rule:**
       - If changes are aligned with documentation (Severity: CONFORMANT), return exactly: `NO_IMPACT`. Do NOT generate a table row.
       - If there IS a gap (NON-CONFORMANT, GAP, INCONSISTENCY), return ONLY a Markdown table row.
    
    **CORRECTIVE ACTION REQUIREMENTS:**
    - **Brevity:** The text part of the "Corrective Action" must be **very short and crisp** (e.g., "Add 'Rejected' state").
    - **Diagram Format:** If generating a diagram, use **standard PlantUML code block** ( ```plantuml ... ``` ). 
      Do NOT use Confluence XML macros. Ensure valid C4/standard syntax.
    
    **Row Format (If Gap Found):**
    | ID | Severity | Confluence Section | Impact Scope | SWE.2 Observation | Corrective Action |
    | 1 | üî¥ **NON-CONFORMANT** | <SECTION_TITLE> | UI/Logic/Data/API | [Observation] | [Short Text] <br/> ```plantuml ... ``` |
    """

    user_prompt = f"""
    <SECTION_TITLE>{section_header}</SECTION_TITLE>
    
    CONFLUENCE TEXT CONTENT:
    {section_content}

    --- 
    
    LOCAL DIAGRAMS (PlantUML Logic):
    {prompt_diagrams}

    ---
    
    GITHUB CODE DIFF:
    {full_diff}
    """
    
    try:
        response = client.chat.completions.create(
            model=deployment_name,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.1
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        print(f"Error analyzing section '{section_header}': {e}")
        return "NO_IMPACT"
