import requests
import argparse
import sys

def get_github_diff(owner, repo, base_tag, head_tag, github_token=None):
    """
    Fetches the diff between two tags in a GitHub repository.
    
    :param owner: Repository owner (e.g., 'facebook')
    :param repo: Repository name (e.g., 'react')
    :param base_tag: The older tag (e.g., 'v18.0.0')
    :param head_tag: The newer tag (e.g., 'v18.2.0')
    :param github_token: Optional Personal Access Token for authentication
    :return: The diff content as a string
    """
    
    # GitHub API endpoint for comparing two references
    # The '...' syntax finds the common ancestor to compare changes (merge-base)
    url = f"https://api.github.com/repos/{owner}/{repo}/compare/{base_tag}...{head_tag}"
    
    headers = {
        # This header is crucial! It tells GitHub to return the raw diff/patch format
        # instead of a JSON object with commit stats.
        "Accept": "application/vnd.github.v3.diff"
    }
    
    if github_token:
        headers["Authorization"] = f"token {github_token}"
    
    try:
        print(f"Fetching diff from {owner}/{repo}: {base_tag} -> {head_tag}...")
        
        response = requests.get(url, headers=headers)
        
        if response.status_code == 200:
            return response.text
        elif response.status_code == 401:
            raise Exception("Error: Bad credentials. Check your GitHub Token.")
        elif response.status_code == 404:
            raise Exception("Error: Repository not found or one of the tags does not exist.")
        else:
            raise Exception(f"Error: GitHub API returned status {response.status_code} - {response.text}")
            
    except requests.exceptions.RequestException as e:
        raise Exception(f"Network error occurred: {e}")

def main():
    parser = argparse.ArgumentParser(description="Fetch code diff between two GitHub tags.")
    parser.add_argument("owner", help="Repository owner (username or org)")
    parser.add_argument("repo", help="Repository name")
    parser.add_argument("base", help="Base tag (older version)")
    parser.add_argument("head", help="Head tag (newer version)")
    parser.add_argument("-t", "--token", help="Optional: GitHub Personal Access Token", default=None)
    parser.add_argument("-o", "--output", help="Optional: File path to save the diff", default=None)
    
    args = parser.parse_args()
    
    try:
        diff_content = get_github_diff(args.owner, args.repo, args.base, args.head, args.token)
        
        if args.output:
            with open(args.output, "w", encoding="utf-8") as f:
                f.write(diff_content)
            print(f"Success! Diff saved to {args.output}")
        else:
            print("-" * 20 + " DIFF START " + "-" * 20)
            print(diff_content)
            print("-" * 20 + " DIFF END " + "-" * 20)
            
    except Exception as e:
        print(f"\n{str(e)}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
